<% 
items.forEach(item => {
  item.entries.sort((a, b) => {
    var dateA = new Date(a.start || a.year)
    var dateB = new Date(b.start || b.year)
    return dateB - dateA
  })
})

if (templateParams.entries_after_year) {
  items = items.map(item => {
    return {
      ...item,
      entries: item.entries.filter(entry => {
        const after_year = new Date(templateParams.entries_after_year)
        const entryDate = new Date(entry.start || entry.year)
        return entryDate > after_year
      })
    }
  })
}
%>

<% for (const section of templateParams.sections) { %>
<% const item = items.filter(element => element.section == section)[0] %>
## {{< fa <%- item.icon %> >}} <%= item.section %>

<% if (item.description) { %>
<%= item.description %>
<% } %>

<% for (const entry of item.entries) { %>
<% if (entry.href) { %>
  <% var title = '**[' + entry.title + '](' + entry.href + ')**' %>
<% } else { %>
  <% var title = '**' + entry.title + '**' %>
<% } %> 

<!-- TODO: This is needed only because I can't get Quarto to assign them as dates -->
<% if (entry.year) { %>
  <% var date_range = entry.year %>
<% } else { %> 
  <% let start_as_date = new Date(entry.start + "T12:00:00Z") %>
  <% let start = new Intl.DateTimeFormat('en-GB', { dateStyle: 'medium'}).format(start_as_date) %>
  <% if (entry.end) { %>
    <% let end_as_date = new Date(entry.end + "T12:00:00Z") %>
    <% let end = new Intl.DateTimeFormat('en-GB', { dateStyle: 'medium'}).format(end_as_date) %>
    <% if (entry.start == entry.end) { %>
      <% var date_range = start %>
    <% } else { %>
      <% var date_range = start + ' to ' + end %>
    <% } %>
  <% } else { %> 
    <% var date_range = start + ' to present' %>
  <% } %> 
<% } %> 

<% if (entry.organization) { %>
  <% var location = entry.organization + ', ' + entry.location %>
<% } else if (entry.location) { %> 
  <% var location = entry.location %>
<% } %> 

| <%= title %>
| {{< fa calendar-days >}} <%= date_range %> | {{< fa location-dot >}} <%= location %>

<% if (entry.isbn) { %>
ISBN: [<%= entry.isbn %>](https://barcodelookup.com/<%= entry.isbn %>)
<% } %> 

<% if (entry.doi) { %>
::: {layout-ncol="3"}
<% if (Array.isArray(entry.doi)) { %>
<% for (const doi of entry.doi) { %>
{{< ai doi >}} [<%= doi %>](https://doi.org/<%= doi %>)
<% } %> 
<% } else { %> 
{{< ai doi >}} [<%= entry.doi %>](https://doi.org/<%= entry.doi %>)
<% } %> 
:::
<% } %> 

<% if (entry.type) { %>
  <% var presentation_type = '*Presentation type*: ' + entry.type %>
<% } else { %>
  <% var presentation_type = '' %>
<% } %>

<% if (entry.description) { %>
  <% var description = entry.description %>
<% } else { %>
  <% var description = '' %>
<% } %>

<% if (entry.supervisor) { %>
  <% var supervisor = 'Supervisor: ' + entry.supervisor %>
<% } else { %>
  <% var supervisor = '' %>
<% } %>

<% if (entry.description) { %>
<%= description %> <%= presentation_type %> <%= supervisor %>
<% } %>

<% } %>
<% } %>
